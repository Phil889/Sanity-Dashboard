---
phase: 04-untranslated-page-detection
plan: 02
type: execute
depends_on: []
files_modified: [src/tools/scan-local-translations.ts]
---

<objective>
Build a CLI tool that scans the local filesystem for existing English translation files, mapping them to page slugs to identify work already done locally.

Purpose: Reconcile local filesystem state with Sanity state — avoid re-translating pages that already have local translation files.
Output: `src/tools/scan-local-translations.ts` — CLI tool producing a manifest of existing local translation files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key prior summaries:
@.planning/phases/01-audit-assessment/01-02-SUMMARY.md
@.planning/phases/03-core-infrastructure/03-01-SUMMARY.md

# Infrastructure to use:
@src/lib/logger.ts

# Pattern reference:
@src/tools/faq-batch-runner.ts

**Tech stack available:** Node.js fs/promises, path, tsx ^4.0.0, TypeScript 5 (ESM)
**Established patterns:** logger with emoji prefixes, CLI arg parsing via process.argv

**Constraining decisions:**
- Decision #4: Tracker is unreliable; scan actual files instead
- From 01-02: English translations are `create-*-en.ts` and `import-*-en.ts` in `ADVISORI Sanity Migration/`
- From 01-02: FAQ batch files are `*-en-faqs-batch*.ts` (377 files, handled by faq-batch-runner)
- From 01-01: `de-pages-created/` contains only German source pages (NOT translations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scan-local-translations.ts CLI tool</name>
  <files>src/tools/scan-local-translations.ts</files>
  <action>
Create `src/tools/scan-local-translations.ts` — a CLI tool that scans the local filesystem for existing English translation files.

**Scan directory:** `ADVISORI Sanity Migration/` (relative to project root)
**Exclude:** `node_modules/`, `de-pages-created/`

**File patterns to detect:**

1. **Main translation files** — two naming patterns:
   - `create-{slug}-en.ts` — creates a new English page (older pattern)
   - `import-{slug}-en.ts` — imports an English page (newer pattern)
   Extract slug by removing `create-`/`import-` prefix and `-en.ts` suffix.

2. **FAQ batch files** — already handled by faq-batch-runner, but count them:
   - `{slug}-en-faqs-batch{N}.ts` — FAQ batches for a page
   Extract slug by removing `-en-faqs-batch{N}.ts` suffix.

3. **Source JSON files** — German content extracts:
   - `{slug}-source.json` or `{slug}-source-correct.json`
   These indicate extraction was done for a page.

**Output structure:**
```typescript
interface LocalScanReport {
  timestamp: string;
  scanDirectory: string;
  summary: {
    totalMainFiles: number;    // create-*-en.ts + import-*-en.ts
    totalFaqBatchFiles: number; // *-en-faqs-batch*.ts
    totalSourceJsonFiles: number; // *-source.json
    uniqueSlugs: number;        // distinct page slugs found
  };
  pages: Array<{
    slug: string;
    mainFile: string | null;     // filename of create-*-en.ts or import-*-en.ts
    faqBatchFiles: string[];     // filenames of FAQ batch files
    sourceJsonFile: string | null; // filename of source JSON
    hasFaqs: boolean;
    estimatedCompleteness: 'full' | 'main-only' | 'faqs-only' | 'source-only';
  }>;
}
```

**estimatedCompleteness logic:**
- `full`: has mainFile AND (hasFaqs with faqBatchFiles.length > 0, OR no FAQ batches expected)
- `main-only`: has mainFile but no FAQ batch files (may or may not need FAQs)
- `faqs-only`: has FAQ batch files but no mainFile (unusual)
- `source-only`: has only source JSON (extraction done, translation not started)

**CLI flags:**
- Default: human-readable summary with slug list
- `--json`: full JSON report to stdout
- `--json --output <path>`: write JSON to file

**Implementation notes:**
- Use `readdir` from `node:fs/promises` to list files
- This tool does NOT need the Sanity client (purely filesystem-based)
- Only import from `../lib/logger.js` (no Sanity dependencies)
- Use `logger.search()` for scan messages, `logger.file()` for file discoveries, `logger.stats()` for totals
- Sort pages alphabetically by slug
- ESM imports with `.js` extension
- Add npm script `"scan-local"` to package.json: `"tsx src/tools/scan-local-translations.ts"`
  </action>
  <verify>npx tsc --noEmit (no TypeScript errors)</verify>
  <done>src/tools/scan-local-translations.ts exists, compiles cleanly, npm script "scan-local" added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Run scanner and verify output</name>
  <files>src/tools/scan-local-translations.ts</files>
  <action>
Run the local scanner and verify results make sense.

**Expected from Phase 1 audit:**
- ~637 total .ts files in ADVISORI Sanity Migration/ (excluding de-pages-created/ and node_modules/)
- Known patterns: create-*-en.ts, import-*-en.ts, *-en-faqs-batch*.ts
- 377 EN FAQ batch files across 78 slugs (from 03-04 summary)
- ~64 source JSON files scattered across root and ADVISORI Sanity Migration/

Run: `npx tsx src/tools/scan-local-translations.ts`
Then: `npx tsx src/tools/scan-local-translations.ts --json`

Verify:
1. Tool completes without errors
2. FAQ batch count is close to 377
3. Unique slug count is reasonable (expect 50-150 distinct slugs with main translation files)
4. JSON output is valid and well-structured
5. No slug extraction errors (check a few entries manually)
  </action>
  <verify>npx tsx src/tools/scan-local-translations.ts runs without errors and produces reasonable file counts</verify>
  <done>Scanner runs successfully, file counts are reasonable, JSON output is valid and well-structured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npx tsx src/tools/scan-local-translations.ts` produces human-readable summary
- [ ] `npx tsx src/tools/scan-local-translations.ts --json` produces valid JSON
- [ ] FAQ batch file count is close to 377
- [ ] npm script `scan-local` works: `npm run scan-local`
</verification>

<success_criteria>

- Scanner discovers all English translation files in ADVISORI Sanity Migration/
- Slug extraction works correctly for all naming patterns
- JSON output is machine-readable for downstream tools (04-03)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-untranslated-page-detection/04-02-SUMMARY.md`
</output>
