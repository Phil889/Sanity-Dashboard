---
phase: 07-translation-validation
plan: 01
title: German Remnant Detection and Extended Validation
depends_on: []
estimated_duration: 15min
strategy: A
files_modified:
  - src/tools/validate-translation.ts
  - src/lib/glossary.ts
---

# Plan 07-01: German Remnant Detection and Extended Validation

## Objective

Extend validate-translation.ts (built in 06-04) with additional quality checks that catch issues beyond the original 11 rules: untranslated German text remnants, i18n field consistency, and _id format validation. These checks fill the gap between "translation engine output" and "upload-ready pages."

Purpose: Catch untranslated German content and structural inconsistencies before upload. German remnants are the most likely quality failure at scale — the AI translator may leave technical German phrases or miss entire fields.
Output: Enhanced validate-translation.ts with additional quality checks.

## Context

### What 06-04 already built

`validate-translation.ts` (530 lines) validates all 11 mandatory translation rules:
- Rules 1-11: language, content non-empty, no duplicate FAQs, testimonial fields, emoji preservation, no hallucinated sections, _key patterns, slug format, FAQ count match, sections present, _type: object
- Quality checks: FORBIDDEN_TERMS scan, testimonial name/company match, SEO title suffix, emoji preservation
- Modes: `--file`, `--dir`, `--json`, `--strict`

### What's missing

1. **German text detection** — no check for leftover German words in translated output. DOMAIN_TERMS in glossary.ts contains 48 German terms that should appear in translated form, not original German. Additional common German function words (der, die, das, und, oder, für, etc.) indicate untranslated passages.

2. **i18n field consistency** — no validation that `_id`, `__i18n_lang`, `__i18n_base._ref` are internally consistent:
   - `_id` should end with `-en`
   - `__i18n_lang` should be `'en'`
   - `__i18n_base._ref` should equal `_id` with `-en` stripped
   - `__i18n_base._type` should be `'reference'`

3. **_id format validation** — `_id` must be `{germanId}-en` where `germanId` matches the German source `_id`.

### Design approach

Add these as **quality checks** (not new rules) to avoid changing the 11-rule scoring system. The 11-rule score stays at X/11 for consistency with 06-04. New checks appear in `qualityChecks` and `warnings`.

## Tasks

### Task 1: Add German remnant detection

**Do:**

1. Add `GERMAN_STOP_WORDS` to `src/lib/glossary.ts` — a list of ~30 common German function words that reliably indicate untranslated text:
   ```
   der, die, das, ein, eine, und, oder, aber, für, mit, von, zu, auf, in, an, aus,
   bei, nach, vor, über, unter, zwischen, durch, ohne, gegen, bis, seit, während, weil, dass
   ```
   Export as `readonly string[]`.

   **Important:** These are SHORT words that could appear as English substrings. The detection must use **word boundary matching** (`\b` regex) to avoid false positives like "under" matching "und" or "diesel" matching "die".

2. In `validate-translation.ts`, add a `detectGermanRemnants()` helper function that:
   - Takes all text content from the translated page (reuse existing `getAllTextContent()`)
   - Splits into individual words using whitespace/punctuation
   - Checks each word against GERMAN_STOP_WORDS using case-insensitive word boundary regex
   - Also checks against DOMAIN_TERMS keys (the German terms) — if a German domain term appears in the translation, it should be in its English form
   - Returns `{ germanWordsFound: string[], domainTermsUntranslated: string[] }`
   - **Filtering:** Exclude terms that are also valid English words or technical acronyms (e.g., "in", "an", "von" as a name). Use a small exclusion list: `['in', 'an', 'on']` — these are also English prepositions. Also exclude proper nouns (BaFin, BSI, MaRisk, etc.) since they appear identically in both languages.

3. Integrate into `validateTranslation()`:
   - Call `detectGermanRemnants()` after existing checks
   - Add results to `qualityChecks` as new fields: `germanWordsFound: string[]` and `domainTermsUntranslated: string[]`
   - If any German remnants found, add warnings (NOT rule failures — keep 11-rule score intact)
   - In `--strict` mode, these warnings cause exit code 1

4. Update `QualityChecks` interface to add the two new fields.

5. Update `displaySingleResult()` and `displayDirectoryReport()` to show German remnant warnings when found.

**Verify:**
- `npm run typecheck` passes
- GERMAN_STOP_WORDS exported from glossary.ts
- `detectGermanRemnants()` works correctly:
  - Does NOT match English words like "under", "diesel", "and" (word boundary test)
  - DOES match German "und", "für", "über" when they appear as standalone words
  - DOES detect untranslated DOMAIN_TERMS keys (e.g., "Risikobewertung" appearing in English text)
  - Does NOT flag proper nouns (BaFin, BSI, MaRisk)

### Task 2: Add i18n field and _id consistency checks

**Do:**

1. In `validateTranslation()`, add i18n consistency checks after existing Rule 11:

   a. **_id format check**: `_id` must end with `-en`. If German source provided, `_id` must equal `${german._id}-en`.
   b. **__i18n_lang check**: Must be `'en'`.
   c. **__i18n_base check**: Must be an object with `_ref` (string) and `_type: 'reference'`. If German source provided, `__i18n_base._ref` must equal `german._id`.
   d. **Cross-consistency**: `_id` stripped of `-en` suffix must equal `__i18n_base._ref`.

2. Add these as quality checks (not rules) — add to `qualityChecks` interface:
   - `idFormatValid: boolean`
   - `i18nFieldsConsistent: boolean`

3. If any fail, add to warnings array with descriptive messages.

4. Update display functions to show i18n consistency status.

**Verify:**
- `npm run typecheck` passes
- Correct _id + i18n fields pass silently
- Wrong _id (missing -en suffix) triggers warning
- Missing __i18n_base triggers warning
- Mismatched __i18n_base._ref vs _id triggers warning
- Quality checks appear in --json output

## Verification

- [ ] validate-translation.ts still passes typecheck
- [ ] 11-rule scoring unchanged (still X/11)
- [ ] German remnant detection uses word boundaries (no false positives on "under", "diesel")
- [ ] DOMAIN_TERMS detection works (finds untranslated German terms)
- [ ] i18n consistency checks validate _id, __i18n_lang, __i18n_base
- [ ] --strict mode treats new warnings as errors
- [ ] --json output includes new quality check fields
- [ ] Display functions show new checks in human-readable output
- [ ] `npm run typecheck` passes

## Output

- `src/lib/glossary.ts` — GERMAN_STOP_WORDS added
- `src/tools/validate-translation.ts` — German remnant detection + i18n consistency checks added
