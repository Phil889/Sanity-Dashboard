---
phase: 07-translation-validation
plan: 02
title: Auto-Fix Pipeline and Batch Validation Report
depends_on: ["07-01"]
estimated_duration: 15min
strategy: A
files_modified:
  - src/tools/fix-translation.ts (new)
  - src/tools/validate-batch-report.ts (new)
  - package.json
---

# Plan 07-02: Auto-Fix Pipeline and Batch Validation Report

## Objective

Build two tools that complete the validation phase: (1) an auto-fix tool that repairs common translation issues without re-running the AI translator, and (2) a batch validation report generator that produces a markdown report showing upload readiness across all translated pages.

Purpose: At 587 pages, manual fixing is impractical. Auto-fix handles deterministic repairs; the report shows which pages are ready for Phase 8 upload.
Output: `fix-translation.ts` (auto-fix CLI), `validate-batch-report.ts` (markdown report generator).

## Context

### The fix-then-validate pipeline

After `translate-batch.ts` produces translated JSONs:
1. `fix-translation.ts` — auto-repairs common issues (deterministic, no AI needed)
2. `validate-translation.ts` — validates all rules + extended checks from 07-01
3. `validate-batch-report.ts` — generates markdown report of batch status

### Common fixable issues (from 06-02 and 06-04 analysis)

| Issue | Fix | Deterministic? |
|-------|-----|----------------|
| `seo.title` missing `\| ADVISORI` suffix | Append suffix | Yes |
| Array items with wrong `_type` | Set to `"object"` | Yes |
| `_key` values not matching pattern | Regenerate with `generateKey()` | Yes |
| Missing `__i18n_lang` | Set to `'en'` | Yes |
| Missing `__i18n_base` | Construct from `_id` | Yes |
| `language` not `'en'` | Set to `'en'` | Yes |
| `_id` missing `-en` suffix | Append `-en` | Yes |

All fixes are deterministic string/object operations — no AI call needed.

### Dependencies

- `validateTranslation()` from validate-translation.ts (07-01 enhanced version)
- `generateKey()` from glossary.ts
- `translation-queue.json` from Phase 4 (for coverage stats)
- `src/data/extracted/` and `src/data/translated/` directories

## Tasks

### Task 1: Create auto-fix translation tool

**Do:**
Create `src/tools/fix-translation.ts` (~250 lines) with:

1. **`FixResult`** interface:
   ```typescript
   {
     file: string
     fixesApplied: string[]     // human-readable descriptions of fixes
     fixCount: number
     wasModified: boolean       // true if file was changed
   }
   ```

2. **`fixTranslation(filePath: string, germanPath?: string, options?: FixOptions): Promise<FixResult>`** — exported function:

   Reads the translated JSON, applies all applicable fixes, writes back if modified:

   a. **Language fix**: If `language !== 'en'`, set to `'en'`
   b. **_id fix**: If `_id` doesn't end with `-en`, append `-en`
   c. **__i18n_lang fix**: If missing or not `'en'`, set to `'en'`
   d. **__i18n_base fix**: If missing, construct from `_id` (strip `-en` to get German _id):
      ```typescript
      { _ref: _id.replace(/-en$/, ''), _type: 'reference' }
      ```
   e. **SEO title fix**: If `seo.title` exists but doesn't end with `| ADVISORI`, append ` | ADVISORI`
   f. **Array _type fix**: Walk all arrays, set `_type: 'object'` on any item where `_type` is missing or wrong
   g. **_key fix**: Walk all arrays, if any `_key` doesn't match `prefix_\d+_\d+` pattern, regenerate using `generateKey()` with appropriate prefix (infer from parent key name: `faq` → `'faq'`, `services` → `'service'`, `benefits` → `'benefit'`, `features` → `'feature'`, `points` → `'point'`, etc.)

   **Important:** Only write file if at least one fix was applied. Log each fix applied. Preserve all other fields exactly as-is (use JSON.parse → modify → JSON.stringify with 2-space indent).

3. **`FixOptions`** interface:
   - `dryRun?: boolean` — show fixes without writing file
   - `outputPath?: string` — write to different file instead of overwriting

4. **`fixTranslationDirectory(dirPath: string, germanDirPath?: string, options?: FixOptions): Promise<FixResult[]>`** — exported function:
   - Processes all `*-en.json` files in directory
   - Matches German source by filename (strip `-en`)
   - Returns array of FixResults

5. **CLI interface:**
   - `--file <path>` — fix a single file
   - `--german <path>` — optional German source
   - `--dir <path>` — fix all files in directory
   - `--german-dir <path>` — German source directory
   - `--dry-run` — show fixes without applying
   - `--json` — output results as JSON

6. **npm script**: Add `"fix-translation": "tsx src/tools/fix-translation.ts"` to package.json

**Verify:**
- `npm run typecheck` passes
- Module exports `fixTranslation` and `fixTranslationDirectory`
- `--dry-run` shows fixes without modifying files
- `--json` outputs valid JSON results

### Task 2: Create batch validation report generator

**Do:**
Create `src/tools/validate-batch-report.ts` (~200 lines) with:

1. **`generateValidationReport(options: ReportOptions): Promise<string>`** — exported function:

   a. Load `translation-queue.json` for total page count and slugs
   b. Scan `src/data/extracted/` for extracted page count
   c. Scan `src/data/translated/` for translated page count
   d. Run `validateTranslationDirectory()` on all translated files (with German cross-validation from extracted dir)
   e. Generate a markdown report string with:

   ```markdown
   # Translation Validation Report

   Generated: {timestamp}

   ## Pipeline Coverage

   | Stage | Count | % of Total |
   |-------|-------|------------|
   | Total in queue | 587 | 100% |
   | Extracted | {n} | {%} |
   | Translated | {n} | {%} |
   | Valid (11/11) | {n} | {%} |
   | Upload-ready | {n} | {%} |

   ## Validation Summary

   - Average score: {n}/11
   - Pages with warnings: {n}
   - Pages with German remnants: {n}
   - Pages with forbidden terms: {n}

   ## Common Failures

   | Rule | Name | Fail Count |
   |------|------|------------|
   | ... | ... | ... |

   ## Invalid Pages (Require Attention)

   | Page | Score | Failed Rules | Issues |
   |------|-------|-------------|--------|
   | ... | ... | ... | ... |

   ## Pages with Warnings

   | Page | Warnings |
   |------|----------|
   | ... | ... |
   ```

   f. If `--output` specified, write to file. Otherwise print to stdout.

2. **`ReportOptions`** interface:
   - `translatedDir?: string` — defaults to `src/data/translated`
   - `extractedDir?: string` — defaults to `src/data/extracted`
   - `queuePath?: string` — defaults to `src/data/translation-queue.json`
   - `outputPath?: string` — write report to file
   - `json?: boolean` — output raw data as JSON instead of markdown

3. **CLI interface:**
   - `--translated-dir <path>` — translated files directory
   - `--extracted-dir <path>` — extracted files directory (for cross-validation)
   - `--queue <path>` — translation queue file
   - `--output <path>` — write report to file (default: stdout)
   - `--json` — JSON output instead of markdown

4. **npm script**: Add `"validate-report": "tsx src/tools/validate-batch-report.ts"` to package.json

**Verify:**
- `npm run typecheck` passes
- Module exports `generateValidationReport`
- Report includes pipeline coverage stats
- Report lists invalid pages with specific failure reasons
- `--json` outputs structured data
- `--output` writes to file
- `npm run validate-report` works via npm script

## Verification

- [ ] fix-translation.ts exports fixTranslation() and fixTranslationDirectory()
- [ ] All 7 fix types work correctly (language, _id, i18n_lang, i18n_base, SEO, _type, _key)
- [ ] --dry-run shows fixes without writing
- [ ] validate-batch-report.ts exports generateValidationReport()
- [ ] Report shows pipeline coverage (queue → extracted → translated → valid)
- [ ] Report lists common failures and invalid pages
- [ ] Both tools have working npm scripts
- [ ] `npm run typecheck` passes

## Output

- `src/tools/fix-translation.ts` — auto-fix pipeline with CLI
- `src/tools/validate-batch-report.ts` — batch validation report generator
- `package.json` — "fix-translation" and "validate-report" npm scripts added
