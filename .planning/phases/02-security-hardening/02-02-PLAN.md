---
phase: 02-security-hardening
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [ADVISORI Sanity Migration/*.ts]
---

<objective>
Remove hardcoded API credentials from all active TypeScript scripts by replacing the token string with environment variable references.

Purpose: Eliminate the critical security vulnerability of having the Sanity API token in plaintext across ~569 files. After this plan, no active script will contain the hardcoded token.
Output: All .ts files in ADVISORI Sanity Migration/ (excluding de-pages-created/) use process.env.SANITY_API_TOKEN instead of hardcoded token.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-security-hardening/02-01-SUMMARY.md
@.planning/phases/01-audit-assessment/01-01-SUMMARY.md
@.planning/phases/01-audit-assessment/01-02-SUMMARY.md

**Constraining decisions:**
- Phase 1 found ~569 files with hardcoded token in `ADVISORI Sanity Migration/` (excluding de-pages-created/)
- 68 files already use dotenv pattern (process.env.SANITY_API_TOKEN)
- The exact hardcoded token string is: `[REDACTED-TOKEN]`
- An .env file exists at `ADVISORI Sanity Migration/.env` with SANITY_API_TOKEN
- dotenv is already installed in ADVISORI Sanity Migration/node_modules/
- File categories: 14 check, 49 create, 102 fetch, 78 import, 12 verify, 4 fix, 377 FAQ batch, plus others
- de-pages-created/ (3,229 files) is reference-only — handle separately with lower priority
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded token in all active scripts (ADVISORI Sanity Migration/ level)</name>
  <files>ADVISORI Sanity Migration/*.ts</files>
  <action>
  Create a temporary Node.js cleanup script that processes all .ts files in `ADVISORI Sanity Migration/` (excluding `de-pages-created/` and `node_modules/`):

  **For each .ts file:**

  1. Read the file content
  2. Check if it contains the hardcoded token string: `[REDACTED-TOKEN]`
  3. If found:
     a. Replace the token string (including surrounding quotes) with `process.env.SANITY_API_TOKEN`
        - Handle both single and double quotes: `'sk...'` → `process.env.SANITY_API_TOKEN`
        - The replacement in context: `token: 'sk...'` → `token: process.env.SANITY_API_TOKEN`
     b. Check if the file already imports dotenv. If NOT, add `import 'dotenv/config'` as the FIRST import line (before the @sanity/client import)
     c. Track the file as modified
  4. If file already uses `process.env.SANITY_API_TOKEN` — skip, log as already clean
  5. Write modified content back to file

  **Important details:**
  - The token is always on a line like: `token: 'skNQVXst...'` or `token: "skNQVXst..."`
  - Some files have the token in a createClient() call, others in a standalone variable
  - Do NOT modify files in de-pages-created/ or node_modules/
  - The dotenv import must use `import 'dotenv/config'` (side-effect import) not `import dotenv from 'dotenv'` — the side-effect form auto-calls config() and is simpler
  - The .env file is at `ADVISORI Sanity Migration/.env` — dotenv will find it when scripts run from that directory
  - Log a summary: total files scanned, files modified, files already clean, files with no token

  Run the cleanup script with `npx tsx` from the `ADVISORI Sanity Migration/` directory.
  Delete the cleanup script after it runs successfully.
  </action>
  <verify>
  After running:
  1. Grep for the hardcoded token string across ADVISORI Sanity Migration/*.ts (excluding de-pages-created/) — should return 0 matches
  2. Grep for `process.env.SANITY_API_TOKEN` — should match ~569+ files
  3. Grep for `import 'dotenv/config'` — should match all files that were modified
  4. Spot-check 3 modified files (one check-*.ts, one create-*-en.ts, one FAQ batch) to verify syntax is valid
  </verify>
  <done>Zero hardcoded tokens remaining in ADVISORI Sanity Migration/ active scripts. All modified files import dotenv.</done>
</task>

<task type="auto">
  <name>Task 2: Handle de-pages-created/ reference files</name>
  <files>ADVISORI Sanity Migration/de-pages-created/*.ts</files>
  <action>
  The `de-pages-created/` directory has 3,229 German page creation scripts that are reference-only (won't be run again). However, they still contain the plaintext API token which is a security concern if the repo is shared.

  **Approach: Simple string replacement (no dotenv needed since files won't be executed)**

  1. Create a simple script that:
     - Reads all .ts files in `de-pages-created/` (excluding node_modules/)
     - Replaces the hardcoded token string with `process.env.SANITY_API_TOKEN`
     - Adds `import 'dotenv/config'` before the @sanity/client import (for consistency)
     - Tracks modified count

  2. Run the script. Expected: ~3,229 files modified.

  3. Delete the cleanup script after completion.

  **Why bother if they're reference-only:** The token in plaintext across 3,229 files is a liability. If this repo is ever shared, cloned, or backed up, the token is exposed. A bulk replacement is cheap and eliminates the risk entirely.

  **If this takes too long or fails:** Skip de-pages-created/ and document it as a deferred issue. The active scripts (Task 1) are the priority.
  </action>
  <verify>
  1. Grep for hardcoded token in de-pages-created/*.ts — should return 0 matches
  2. Spot-check 2 files to verify replacement looks correct
  3. Count modified files — should be ~3,229
  </verify>
  <done>Hardcoded token removed from de-pages-created/ reference files. Total files cleaned across project documented.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Zero files in ADVISORI Sanity Migration/ (excluding node_modules/) contain the hardcoded token string
- [ ] All modified files have `import 'dotenv/config'` import
- [ ] Spot-checked files have valid TypeScript syntax after replacement
- [ ] Cleanup scripts deleted (no temporary files left behind)
- [ ] Total files modified logged in summary
</verification>

<success_criteria>

- Hardcoded API token eliminated from all .ts files in the project
- Modified files use process.env.SANITY_API_TOKEN
- All modified files import dotenv/config
- No cleanup scripts left in the project
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-hardening/02-02-SUMMARY.md`
</output>
