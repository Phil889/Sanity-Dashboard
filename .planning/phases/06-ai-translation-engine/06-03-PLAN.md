---
phase: 06-ai-translation-engine
plan: 03
title: Batch Translation Pipeline
depends_on: ["06-02"]
estimated_duration: 15min
strategy: A
files_modified:
  - src/tools/translate-batch.ts (new)
  - package.json
  - .gitignore
---

# Plan 06-03: Batch Translation Pipeline

## Objective

Build a batch translation tool that processes multiple extracted German pages through the translation engine, with rate limiting, cost tracking, resume support, and progress reporting. Mirrors the pattern of `extract-batch.ts` (Phase 5) but for translation.

## Context

### Dependencies

- `translatePage()` from `src/tools/translate-page.ts` (06-02)
- `src/data/translation-queue.json` — 587 entries with germanId and slug
- `src/data/extracted/` — extracted German page JSONs from Phase 5

### Design patterns to follow

From `extract-batch.ts` (05-02):
- Sequential processing with configurable delay (translation is rate-limited by Claude API)
- Skip-existing for resume support (re-run skips already-translated pages)
- Consecutive failure abort (5 failures = likely auth or systemic issue)
- JSON summary output for pipeline integration
- Exported function + CLI interface

### Rate limiting considerations

- Claude API has rate limits (requests per minute, tokens per minute)
- Default delay between requests should be higher than extraction (2000ms vs 200ms)
- Track token usage to estimate total cost
- Log cost per page and running total

### Cost estimation

- Average servicePage: ~3000 input tokens, ~3000 output tokens
- Claude Sonnet 4.5: ~$3/MTok input, ~$15/MTok output
- Per page: ~$0.009 + ~$0.045 = ~$0.054
- Full batch (587 pages): ~$32 estimated total

## Tasks

### Task 1: Create batch translation pipeline

**Do:**
Create `src/tools/translate-batch.ts` (~300 lines) following the `extract-batch.ts` pattern:

1. **`BatchTranslationSummary`** interface:
   ```typescript
   {
     translated: number
     skipped: number
     failed: number
     totalInputTokens: number
     totalOutputTokens: number
     estimatedCostUsd: number
     durationMs: number
     failedPages: Array<{ slug: string; error: string }>
   }
   ```

2. **`runBatchTranslation(options: BatchTranslationOptions): Promise<BatchTranslationSummary>`** — exported function:

   a. **Load queue** — read translation-queue.json, filter to entries with extracted files
   b. **Process sequentially** — for each entry:
      - Check if translated output already exists (skip if `--force` not set)
      - Check if extracted input exists (skip with warning if not)
      - Call `translatePage()` with input from `src/data/extracted/{slug}.json`
      - Write output to `src/data/translated/{slug}-en.json`
      - Track token usage and costs
      - Log progress: `[current/total] Translated: {slug} ({inputTokens}+{outputTokens} tokens, ${cost})`
      - Wait `--delay` ms before next request
   c. **Consecutive failure handling** — abort after N consecutive failures (default 3, lower than extraction because API key issues are more costly)
   d. **Summary** — log totals: translated, skipped, failed, total tokens, estimated cost, duration

3. **`BatchTranslationOptions`** interface:
   - `limit?: number` — max pages to translate (for testing)
   - `force?: boolean` — re-translate even if output exists
   - `delay?: number` — ms between API calls (default 2000)
   - `maxConsecutiveFailures?: number` — abort threshold (default 3)
   - `outputDir?: string` — override output directory
   - `extractedDir?: string` — override extracted files directory
   - `queuePath?: string` — override queue file path
   - `jsonOutput?: boolean` — output summary as JSON

4. **CLI arguments**:
   - `--limit <N>` — translate at most N pages
   - `--force` — re-translate existing files
   - `--delay <ms>` — delay between API calls (default 2000)
   - `--output-dir <path>` — output directory (default `src/data/translated`)
   - `--extracted-dir <path>` — extracted files directory (default `src/data/extracted`)
   - `--queue <path>` — queue file path
   - `--json` — JSON summary output

5. **Cost tracking**:
   - Track input and output tokens per page
   - Calculate estimated cost using model-specific pricing:
     - Sonnet 4.5: $3/MTok input, $15/MTok output
     - Haiku 4.5: $0.80/MTok input, $4/MTok output
   - Log running cost total after each page
   - Include total in summary

6. **npm script**: Add `"translate-batch": "tsx src/tools/translate-batch.ts"` to package.json

7. **gitignore**: Add `src/data/translated/*.json` to `.gitignore` (regenerable data)

8. **Directory**: Create `src/data/translated/.gitkeep`

**Verify:**
- `npm run typecheck` passes
- Module exports `runBatchTranslation` and `BatchTranslationSummary`

### Task 2: Verify with sample batch

**Do:**
1. Ensure at least 5 extracted pages exist in `src/data/extracted/`:
   ```bash
   npx tsx src/tools/extract-batch.ts --limit 5
   ```

2. Run batch translation with limit:
   ```bash
   npx tsx src/tools/translate-batch.ts --limit 3
   ```

3. Verify:
   - 3 translated JSON files created in `src/data/translated/`
   - Each file has correct structure (check _id, language, slug, i18n fields)
   - Skip-existing works: re-running `--limit 3` shows "0 translated, 3 skipped"
   - `--force` overrides: `--limit 1 --force` re-translates
   - `--json` outputs clean JSON summary
   - Cost tracking shows per-page and total token counts + cost estimate
   - Progress logging shows `[1/3]`, `[2/3]`, `[3/3]`

4. Clean up test files after verification

**Verify (all must pass):**
- [ ] 3 pages batch-translated without errors
- [ ] Skip-existing prevents re-translation
- [ ] --force overrides skip behavior
- [ ] --json outputs valid JSON summary
- [ ] Token counts and cost estimates logged
- [ ] Progress indicators show correctly
- [ ] `npm run translate-batch -- --limit 3` works via npm script

## Verification

- [ ] translate-batch.ts exports runBatchTranslation() and BatchTranslationSummary
- [ ] CLI arguments: --limit, --force, --delay, --output-dir, --json all work
- [ ] Sequential processing with configurable delay
- [ ] Skip-existing for resume support
- [ ] Consecutive failure abort at threshold
- [ ] Cost tracking per-page and total
- [ ] `npm run translate-batch` works
- [ ] `src/data/translated/*.json` in .gitignore
- [ ] `npm run typecheck` passes

## Output

- `src/tools/translate-batch.ts` — batch translation pipeline with CLI
- `src/data/translated/.gitkeep` — output directory marker
- `package.json` — "translate-batch" npm script added
- `.gitignore` — translated data exclusion added
