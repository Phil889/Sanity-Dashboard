---
phase: 06-ai-translation-engine
plan: 02
title: Single-Page Translation Engine
depends_on: ["06-01"]
estimated_duration: 25min
strategy: A
files_modified:
  - src/lib/translation-prompt.ts (new)
  - src/tools/translate-page.ts (new)
  - package.json
---

# Plan 06-02: Single-Page Translation Engine

## Objective

Build the core translation engine that takes an extracted German servicePage JSON and produces a fully translated English servicePage JSON ready for Sanity upload. Uses the Claude API with carefully designed prompts that enforce all 11 mandatory translation rules.

## Context

### Input

An `ExtractedPage` JSON file from Phase 5 (e.g., `src/data/extracted/kyc.json`). Contains German content with all system/legacy fields stripped. Example structure:

```json
{
  "_id": "kyc",
  "_type": "servicePage",
  "title": "KYC (Know Your Customer)",
  "slug": { "_type": "slug", "current": "risikomanagement/non-financial-risk/kyc" },
  "language": "de",
  "heroSection": { ... },
  "overview": { ... },
  "approach": { ... },
  "services": [ ... ],
  "faq": [ ... ],
  "seo": { ... },
  "testimonial": { ... },
  "parent": { "_ref": "non-financial-risk", "_type": "reference" },
  "references": { "topLevelParent": { "_ref": "risikomanagement", "_type": "reference" } }
}
```

### Output

A `TranslatedPage` JSON file with:
- All German text translated to English
- `_id`: `kyc-en`
- `language`: `en`
- `slug.current`: `risk-management/non-financial-risk/kyc-en`
- `__i18n_lang`: `en`
- `__i18n_base`: `{ _ref: "kyc", _type: "reference" }`
- `seo.title`: translated + ` | ADVISORI`
- All `_key` values regenerated with new timestamps
- `testimonial.name` and `testimonial.company` preserved from German (not translated)
- `parent` and `references` preserved from German source
- `heroSection.heroImage` preserved from German source (asset references unchanged)

### The 11 Mandatory Translation Rules

1. Language field MUST be 'en' — NOT 'de'
2. Translate German content — No hallucinations
3. No duplicate FAQs — Each FAQ once
4. Testimonial needs all 5 fields — quote, name, position, company, author
5. Preserve formatting — Emojis, bullets, line breaks
6. Check source for optional fields — Only translate what exists
7. Unique _key for array items — `${prefix}_${Date.now()}_${index}`
8. Slugs in kebab-case — Must end with '-en'
9. FAQ count must match — Same number as German
10. Verify before completion — All sections present
11. Use _type: "object" — For all array items

### Translation approach: Hybrid AI + Code

- **AI does:** Translate all German text to English (headings, descriptions, FAQ Q&A, points, etc.)
- **Code does:** Structural transformations (_id, slug, language, _key regeneration, i18n fields, asset preservation)

This separation ensures translation quality from AI while maintaining structural correctness from deterministic code.

## Tasks

### Task 1: Create translation prompt module

**Do:**
Create `src/lib/translation-prompt.ts` with:

1. **`SYSTEM_PROMPT`** — constant string establishing the translator persona and rules:
   - Professional German→English translator for ADVISORI (German consulting firm)
   - Translate accurately — no hallucination, no embellishment
   - Preserve formatting: emojis, bullets (•), line breaks (\n)
   - Keep technical terms and acronyms unchanged (KRITIS, MiFID, MaRisk, BaFin, DORA, NIS2, etc.)
   - Keep company names and personal names unchanged
   - Professional consulting tone, not marketing tone
   - Do NOT add buzzwords from the FORBIDDEN_TERMS list
   - Include the FORBIDDEN_TERMS list inline in the prompt
   - Include key DOMAIN_TERMS for consistent translation
   - Output format: valid JSON object with same structure as input, all text fields translated

2. **`buildUserPrompt(extractedPage: ExtractedPageSchema): string`** — function that:
   - Serializes the ExtractedPage to formatted JSON
   - Wraps it in clear instructions: "Translate all German text fields in this servicePage to English. Return the complete JSON object with translated text. Do NOT modify _key, _type, _ref, or asset fields."
   - Includes specific instructions for:
     - SEO title: translate and append ` | ADVISORI`
     - Testimonial: translate quote and position, keep name and company as-is
     - FAQ answers: preserve emoji formatting and bullet structure exactly
     - If a text field is already in English (some technical terms), leave it as-is

3. **Export both** for use by translate-page.ts

**Verify:**
- `SYSTEM_PROMPT` is a non-empty string containing "ADVISORI" and "11 rules" reference
- `buildUserPrompt()` returns a string containing the JSON of the input page
- `npm run typecheck` passes

### Task 2: Create single-page translation tool

**Do:**
Create `src/tools/translate-page.ts` (~350-450 lines) with:

1. **`translatePage(inputPath: string, options?: TranslateOptions): Promise<TranslationResult>`** — exported function:

   a. **Load** the extracted page JSON from inputPath, parse as ExtractedPageSchema
   b. **Validate** using `validateExtractedPage()` from extraction-types.ts — abort if invalid
   c. **Build prompts** using translation-prompt.ts
   d. **Call Claude API** via @anthropic-ai/sdk:
      ```typescript
      import Anthropic from '@anthropic-ai/sdk'
      const anthropic = new Anthropic({ apiKey: config.anthropic.apiKey })
      const response = await anthropic.messages.create({
        model: config.anthropic.model,
        max_tokens: 8192,
        temperature: 0.3,
        system: SYSTEM_PROMPT,
        messages: [{ role: 'user', content: userPrompt }]
      })
      ```
   e. **Parse response** — extract JSON from Claude's response (handle potential markdown code fences)
   f. **Structural transforms** (deterministic code, not AI):
      - Set `_id` to `${germanId}-en`
      - Set `language` to `'en'`
      - Set `slug.current` using `translateSlug()` from glossary.ts
      - Add `__i18n_lang: 'en'`
      - Add `__i18n_base: { _ref: germanId, _type: 'reference' }`
      - Regenerate all `_key` values using `generateKey()` from glossary.ts
      - Preserve `parent` and `references` from original German source (not from AI output)
      - Preserve `heroSection.heroImage` from original German source
      - Ensure `seo.title` ends with ` | ADVISORI` (add if AI didn't)
      - Ensure `testimonial.name` and `testimonial.company` match German source
   g. **Quick validation** — check translated page has:
      - Same number of FAQs as input (Rule 9)
      - Same number of services as input
      - All required sections present (Rule 10)
      - Language is 'en' (Rule 1)
      - Slug ends with '-en' (Rule 8)
   h. **Return** TranslationResult with translated page, token counts, duration

2. **`TranslateOptions`** interface:
   - `outputPath?: string` — write translated JSON to file
   - `model?: string` — override default model
   - `dryRun?: boolean` — show prompt but don't call API

3. **CLI interface** with argument parsing:
   - `--input <path>` — path to extracted page JSON (required)
   - `--output <path>` — path to write translated JSON (optional, stdout if omitted)
   - `--model <model>` — override Claude model
   - `--dry-run` — print prompt without calling API
   - `--quiet` — suppress logger output

4. **npm script**: Add `"translate": "tsx src/tools/translate-page.ts"` to package.json

5. **Error handling**:
   - Wrap API call in `withRetry()` for transient failures
   - If JSON parsing fails, retry once with a more explicit "return valid JSON only" prompt
   - Log token usage and cost estimate after each translation

**Verify:**
- `npm run typecheck` passes
- `--dry-run` mode shows the prompt without calling the API
- Module exports `translatePage` and `TranslateOptions` for programmatic use

### Task 3: Verify with 3 sample pages

**Do:**
1. First, ensure extracted pages exist. Run extraction for 3 diverse pages if not already present:
   ```bash
   npx tsx src/tools/extract-page.ts --id kyc --output src/data/extracted/kyc.json
   npx tsx src/tools/extract-page.ts --id mifid-best-execution --output src/data/extracted/mifid-best-execution.json
   npx tsx src/tools/extract-page.ts --id kritis-readiness --output src/data/extracted/kritis-readiness.json
   ```

2. Translate each page:
   ```bash
   npx tsx src/tools/translate-page.ts --input src/data/extracted/kyc.json --output src/data/translated/kyc-en.json
   npx tsx src/tools/translate-page.ts --input src/data/extracted/mifid-best-execution.json --output src/data/translated/mifid-best-execution-en.json
   npx tsx src/tools/translate-page.ts --input src/data/extracted/kritis-readiness.json --output src/data/translated/kritis-readiness-en.json
   ```

3. For each translated file, verify:
   - `_id` ends with `-en`
   - `language` is `'en'`
   - `slug.current` ends with `-en`
   - `__i18n_lang` is `'en'`
   - `__i18n_base._ref` matches German `_id`
   - FAQ count matches German source
   - Services count matches German source
   - No FORBIDDEN_TERMS appear in translated text
   - Emojis and bullet formatting preserved in FAQ answers
   - `testimonial.name` matches German source
   - `seo.title` ends with `| ADVISORI`
   - All `_key` values match `${prefix}_\d+_\d+` pattern

4. Compare KYC translation against the existing `ADVISORI Sanity Migration/create-kyc-en.ts` to check quality:
   - Are section headings similar?
   - Is the tone professional (not marketing-heavy)?
   - Are technical terms handled consistently?

5. Clean up test files after verification (delete translated outputs)

**Verify (all must pass):**
- [ ] 3 pages translated without errors
- [ ] All translated pages have correct _id, language, slug, i18n fields
- [ ] FAQ counts match between German source and English output
- [ ] No FORBIDDEN_TERMS in any translated output
- [ ] Emoji formatting preserved in FAQ answers
- [ ] Token usage logged for each translation
- [ ] Quality is comparable to existing manual translations

## Verification

- [ ] translation-prompt.ts exports SYSTEM_PROMPT and buildUserPrompt()
- [ ] translate-page.ts exports translatePage() and has CLI interface
- [ ] `npm run translate -- --input <file> --output <file>` works
- [ ] `npm run translate -- --dry-run --input <file>` shows prompt without API call
- [ ] 3 sample pages translate correctly with all 11 rules satisfied
- [ ] Token usage and cost logged
- [ ] `npm run typecheck` passes

## Output

- `src/lib/translation-prompt.ts` — system prompt + user prompt builder
- `src/tools/translate-page.ts` — single-page translation engine with CLI
- `package.json` — "translate" npm script added
- `src/data/translated/.gitkeep` — output directory marker
