---
phase: 06-ai-translation-engine
plan: 04
title: Translation Quality Validation
depends_on: ["06-02"]
estimated_duration: 15min
strategy: A
files_modified:
  - src/tools/validate-translation.ts (new)
  - package.json
---

# Plan 06-04: Translation Quality Validation

## Objective

Build a translation-specific validation tool that checks translated English pages against all 11 mandatory translation rules, compares structural consistency with the German source, and detects common quality issues (embellishment, missing fields, formatting loss). This tool bridges Phase 6 output to Phase 7 requirements.

## Context

### Why a separate validator (not just reusing validate-extractions.ts)

`validate-extractions.ts` validates German extracted pages against the ExtractedPageSchema. Translated English pages have different requirements:
- Language must be `'en'` (not `'de'`)
- Must have `__i18n_lang` and `__i18n_base` fields
- Must have `_id` ending in `-en`
- Must have `slug.current` ending in `-en`
- `seo.title` must end with `| ADVISORI`
- FAQ count must match German source (Rule 9)
- Must not contain FORBIDDEN_TERMS (embellishment check)
- `testimonial.name` and `testimonial.company` must match German source
- All `_key` values must be unique and match `prefix_timestamp_index` pattern

### Input

A translated English page JSON (output from 06-02/06-03) and optionally the corresponding German source JSON for cross-validation.

### Relationship to Phase 7

Phase 7 (Translation Validation) will build comprehensive validation with quality scoring. This plan builds the foundational rule-checking that Phase 7 extends. Think of this as "structural + rule validation" while Phase 7 adds "content quality validation."

## Tasks

### Task 1: Create translation validation tool

**Do:**
Create `src/tools/validate-translation.ts` (~350 lines) with:

1. **`TranslationValidationResult`** interface:
   ```typescript
   {
     valid: boolean
     ruleResults: Array<{
       rule: number       // 1-11
       name: string       // rule description
       passed: boolean
       details?: string   // failure reason
     }>
     structuralChecks: {
       faqCountMatch: boolean
       servicesCountMatch: boolean
       sectionsPresent: string[]
       sectionsMissing: string[]
     }
     qualityChecks: {
       forbiddenTermsFound: string[]
       testimonialNameMatch: boolean
       testimonialCompanyMatch: boolean
       seoTitleSuffix: boolean
       emojiPreserved: boolean
     }
     score: number        // X/11
   }
   ```

2. **`validateTranslation(translatedPath: string, germanPath?: string): Promise<TranslationValidationResult>`** — exported function:

   **Rule checks (11 rules):**
   - Rule 1: `language === 'en'`
   - Rule 2: Content is non-empty (not null/undefined) for all sections that exist in German source
   - Rule 3: No duplicate FAQ questions (check for exact string matches)
   - Rule 4: Testimonial has all fields: quote, name, position, company (author field check with warning)
   - Rule 5: Emoji count in FAQ answers >= emoji count in German source (formatting preserved)
   - Rule 6: Optional fields present in translation only if present in German source (no hallucinated sections)
   - Rule 7: All _key values match `prefix_\d+_\d+` pattern and are unique
   - Rule 8: `slug.current` ends with `-en` and is kebab-case
   - Rule 9: FAQ count matches German source (requires germanPath)
   - Rule 10: All sections present in German are also present in translation
   - Rule 11: All array items have `_type: 'object'`

   **Structural checks** (require German source):
   - FAQ count: translated vs German
   - Services count: translated vs German
   - Sections present vs German sections

   **Quality checks:**
   - Scan all text fields for FORBIDDEN_TERMS from glossary.ts
   - Compare `testimonial.name` and `testimonial.company` with German source
   - Check `seo.title` ends with `| ADVISORI`
   - Check emoji count in FAQ answers matches German source

3. **CLI interface:**
   - `--file <path>` — validate a single translated JSON
   - `--german <path>` — optional German source for cross-validation
   - `--dir <path>` — validate all translated JSONs in directory
   - `--german-dir <path>` — German source directory for cross-validation (matches by filename)
   - `--json` — output as JSON
   - `--strict` — treat warnings as errors

4. **Directory mode:**
   - Validate all `*-en.json` files in the directory
   - Match each to German source by stripping `-en` from filename
   - Aggregate report: total valid, total invalid, average score, common failures

5. **npm script**: Add `"validate-translation": "tsx src/tools/validate-translation.ts"` to package.json

**Verify:**
- `npm run typecheck` passes
- Module exports `validateTranslation` and `TranslationValidationResult`

### Task 2: Verify with sample translations

**Do:**
1. Ensure at least 3 extracted + translated page pairs exist:
   - Extract 3 pages to `src/data/extracted/`
   - Translate 3 pages to `src/data/translated/`
   (Reuse files from 06-02/06-03 verification, or create new ones)

2. Validate each translated page:
   ```bash
   npx tsx src/tools/validate-translation.ts --file src/data/translated/kyc-en.json --german src/data/extracted/kyc.json
   ```

3. Verify:
   - Score is 11/11 (or close) for well-translated pages
   - FAQ count match is checked correctly
   - FORBIDDEN_TERMS detection works (if any appear)
   - `--dir` mode processes all files and shows aggregate report
   - Exit code 0 for all-valid, 1 for any-invalid

4. Create a synthetic bad translation to test failure detection:
   - Wrong language field
   - Missing FAQs (count mismatch)
   - Slug without `-en`
   - Forbidden terms in text
   - Verify validator catches all issues

5. Clean up test files after verification

**Verify (all must pass):**
- [ ] Valid translations score 11/11
- [ ] Synthetic bad translation detected with specific rule failures
- [ ] FAQ count mismatch detected when German source provided
- [ ] FORBIDDEN_TERMS detected in text content
- [ ] Directory mode aggregates results correctly
- [ ] Exit code 0 for valid, 1 for invalid
- [ ] `npm run validate-translation` works via npm script

## Verification

- [ ] validate-translation.ts exports validateTranslation() and TranslationValidationResult
- [ ] All 11 rules checked individually with pass/fail
- [ ] Cross-validation with German source works (FAQ count, services count, sections)
- [ ] Quality checks: forbidden terms, testimonial consistency, SEO suffix, emoji preservation
- [ ] Single-file mode works with --file and --german
- [ ] Directory mode works with --dir and --german-dir
- [ ] --json outputs valid JSON report
- [ ] Aggregate report shows average score and common failures
- [ ] `npm run typecheck` passes

## Output

- `src/tools/validate-translation.ts` — translation quality validation tool with CLI
- `package.json` — "validate-translation" npm script added
