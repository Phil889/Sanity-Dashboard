---
phase: 03-core-infrastructure
plan: 03
type: execute
depends_on: ["03-01"]
files_modified: [src/lib/errors.ts, src/lib/logger.ts]
---

<objective>
Create error handling and logging utilities for the translation pipeline.

Purpose: Provide consistent error classification, retry logic, and structured logging across all pipeline phases (4-10). Currently every script uses bare console.log/console.error with no retry and no error classification ‚Äî API failures, validation errors, and file system errors are all treated the same.
Output: Error handling module (src/lib/errors.ts) with typed errors and retry utility. Logging module (src/lib/logger.ts) with leveled, emoji-prefixed output matching existing codebase conventions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-infrastructure/03-01-SUMMARY.md

# Existing error handling patterns (from audit):
# - Try/catch at top level of async functions
# - console.error with emoji: console.error('‚ùå Error extracting:', error)
# - process.exit(1) on fatal errors
# - No custom error classes, no retry logic
# - 100+ files with unprotected async Sanity API calls
# - Emoji conventions: üîç search, ‚úÖ success, ‚ùå error, üíæ file ops, üìä stats

# Key concerns from CONCERNS.md:
# - Unprotected async operations (100+ files)
# - Missing input validation
# - No structured logging

**Tech stack available:** Node.js built-ins only (no external logging library needed for a CLI migration tool)
**Established patterns:** console.log/error, emoji prefixes, process.exit(1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error handling module with typed errors and retry</name>
  <files>src/lib/errors.ts</files>
  <action>Create src/lib/errors.ts with:

  1. **Base pipeline error class** extending Error:
     - PipelineError with fields: code (string enum), context (Record&lt;string, unknown&gt;), retryable (boolean)

  2. **Specific error subclasses** (keep minimal ‚Äî only errors the pipeline will actually throw):
     - SanityApiError: For Sanity API failures (retryable: true for 429/5xx, false for 4xx)
     - ValidationError: For content/schema validation failures (retryable: false)
     - ConfigError: For missing env vars or bad config (retryable: false)

  3. **Retry utility function** `withRetry&lt;T&gt;(fn: () => Promise&lt;T&gt;, options?)`:
     - maxRetries: number (default 3)
     - delayMs: number (default 1000)
     - backoffMultiplier: number (default 2) ‚Äî exponential backoff
     - Only retries if error is retryable (check error.retryable if PipelineError, or retry all unknown errors)
     - Logs each retry attempt via console.warn
     - Returns the result of fn() on success
     - Throws the last error after all retries exhausted

  Do NOT add:
  - Circuit breaker logic (overkill for a batch migration tool)
  - Error reporting/telemetry services
  - Complex error hierarchies beyond the 3 classes above

  Why only 3 error classes: The pipeline has 3 failure modes ‚Äî Sanity API errors (network/rate limits), validation errors (bad content), and config errors (bad setup). Adding more creates unused abstractions.</action>
  <verify>`npx tsc --noEmit` passes. Error classes can be instantiated and caught by type.</verify>
  <done>src/lib/errors.ts exports PipelineError, SanityApiError, ValidationError, ConfigError, and withRetry. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create logging module with leveled output and emoji conventions</name>
  <files>src/lib/logger.ts</files>
  <action>Create src/lib/logger.ts with:

  1. **Logger object** with methods matching existing codebase emoji conventions:
     - logger.info(message, ...args) ‚Äî prefixed with no emoji (clean info)
     - logger.success(message, ...args) ‚Äî prefixed with ‚úÖ
     - logger.error(message, ...args) ‚Äî prefixed with ‚ùå
     - logger.warn(message, ...args) ‚Äî prefixed with ‚ö†Ô∏è
     - logger.search(message, ...args) ‚Äî prefixed with üîç
     - logger.file(message, ...args) ‚Äî prefixed with üíæ
     - logger.stats(message, ...args) ‚Äî prefixed with üìä
     - logger.progress(current, total, message) ‚Äî shows progress like "[42/584] Processing..."

  2. **Implementation**: Thin wrappers around console.log/console.error:
     - info, success, search, file, stats, progress ‚Üí console.log
     - error ‚Üí console.error
     - warn ‚Üí console.warn

  3. **Timestamp option**: Optional timestamp prefix for long-running batch operations. Default off. Enable with logger.enableTimestamps().

  Do NOT add:
  - File logging (console output is sufficient ‚Äî redirect to file with shell if needed)
  - Log levels/filtering (every log is relevant in a migration pipeline)
  - Structured JSON output (human readability is priority for CLI tool)
  - External logging libraries (winston, pino ‚Äî overkill for CLI migration scripts)

  Why this approach: Matches existing codebase conventions exactly. Pipeline scripts replace `console.log('üîç Searching...')` with `logger.search('Searching...')` ‚Äî same output, consistent interface.</action>
  <verify>`npx tsc --noEmit` passes. Logger methods produce expected console output with correct emoji prefixes.</verify>
  <done>src/lib/logger.ts exports logger with all methods. Output matches existing emoji conventions. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/lib/errors.ts exists with PipelineError, SanityApiError, ValidationError, ConfigError, withRetry
- [ ] src/lib/logger.ts exists with leveled logging methods
- [ ] `npx tsc --noEmit` passes
- [ ] Error classes extend Error properly (instanceof checks work)
- [ ] withRetry respects retryable flag and exponential backoff
- [ ] Logger output has correct emoji prefixes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Error module provides typed errors and retry
- Logger module matches existing codebase conventions
- No external dependencies added (Node.js built-ins only)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-infrastructure/03-03-SUMMARY.md`
</output>
