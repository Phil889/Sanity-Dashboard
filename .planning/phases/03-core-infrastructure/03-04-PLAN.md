---
phase: 03-core-infrastructure
plan: 04
type: execute
depends_on: ["03-02", "03-03"]
files_modified: [src/tools/faq-batch-runner.ts, package.json]
---

<objective>
Build an EN FAQ batch runner that can execute the 377 existing FAQ batch files against Sanity, uploading FAQ content to their corresponding English pages.

Purpose: The 377 EN FAQ batch files (e.g., crisis-management-bcm-en-faqs-batch1.ts) are export-only data — they define FAQ arrays but have no execution mechanism. Some batch files DO have their own Sanity client and patch logic (like employee-training-en-faqs-batch1.ts), but there is no unified way to run them in batch. This tool provides a reliable batch runner using the shared infrastructure.
Output: CLI tool (src/tools/faq-batch-runner.ts) that can process FAQ batch files individually or in bulk, with dry-run mode, progress tracking, and error handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-infrastructure/03-02-SUMMARY.md
@.planning/phases/03-core-infrastructure/03-03-SUMMARY.md

# FAQ batch file patterns (from audit):
# Pattern A - Export only (majority):
# ```typescript
# export const crisisManagementBcmEnFaqsBatch1 = [
#   { _type: 'object', _key: 'faq_en_1', question: "...", answer: "..." },
#   { _type: 'object', _key: 'faq_en_2', question: "...", answer: "..." },
# ]
# ```
#
# Pattern B - Self-executing (some files):
# ```typescript
# async function addFaqsBatch1() {
#   const result = await client
#     .patch('employee-training-en')
#     .setIfMissing({ faq: [] })
#     .append('faq', faqsBatch1)
#     .commit()
# }
# addFaqsBatch1()
# ```
#
# Key facts:
# - 377 FAQ batch files in ADVISORI Sanity Migration/
# - Naming: {slug}-en-faqs-batch{N}.ts (N typically 1-5)
# - Each batch has 3-5 FAQ items
# - Target document ID derived from slug: e.g., "crisis-management-bcm-en" patches document with _id "crisis-management-bcm-en"
# - Patch pattern: client.patch(docId).setIfMissing({faq:[]}).append('faq', items).commit()
# - FAQ items have: _type, _key, question, answer

**Tech stack available:** Shared Sanity client (03-02), error handling + logger (03-03)
**Established patterns:** .patch().setIfMissing({faq:[]}).append('faq', items).commit()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FAQ batch runner tool</name>
  <files>src/tools/faq-batch-runner.ts, package.json</files>
  <action>Create src/tools/faq-batch-runner.ts — a CLI tool that processes FAQ batch files.

  **Discovery logic** — Find FAQ batch files:
  - Scan ADVISORI Sanity Migration/ for files matching pattern `*-en-faqs-batch*.ts`
  - Group by page slug (extract slug from filename: everything before `-en-faqs-batch`)
  - Sort batches numerically within each group (batch1, batch2, etc.)

  **Execution logic** for each batch file:
  - Dynamically import the .ts file using tsx/Node.js import()
  - Find the exported array (the default export or first exported const that is an array)
  - Derive target document ID from slug: `{slug}-en` (e.g., "crisis-management-bcm-en")
  - Use shared Sanity client to patch: `client.patch(docId).setIfMissing({faq:[]}).append('faq', faqItems).commit()`
  - Use withRetry from errors module for each patch operation
  - Log progress using logger module

  **CLI interface** (parse process.argv):
  - `npx tsx src/tools/faq-batch-runner.ts` — list all discoverable FAQ batch files (dry-run by default)
  - `npx tsx src/tools/faq-batch-runner.ts --slug crisis-management-bcm` — process only batches for this slug
  - `npx tsx src/tools/faq-batch-runner.ts --execute` — actually run all batches against Sanity
  - `npx tsx src/tools/faq-batch-runner.ts --slug crisis-management-bcm --execute` — run specific slug

  **Safety features**:
  - Default mode is dry-run (list files and planned actions, no mutations)
  - --execute flag required to actually modify Sanity
  - Before patching, verify target document exists in Sanity (query by _id). Skip and warn if document not found.
  - Log each batch: "Appending N FAQs to {docId} from {filename}"
  - Summary at end: X batches processed, Y FAQs added, Z skipped/failed

  **Error handling**:
  - If a batch file can't be imported (syntax error, no export), log error and continue to next
  - If Sanity patch fails after retries, log error with document ID and continue
  - Never process.exit(1) on partial failure — complete the run and report summary

  Add npm script to package.json: "faq-batch" → "tsx src/tools/faq-batch-runner.ts"

  Do NOT:
  - Execute Pattern B files directly (they have their own client) — the runner uses the shared client for consistency
  - Modify any existing batch files
  - Process files in de-pages-created/ (those are German page scripts, not FAQ batches)</action>
  <verify>`npx tsc --noEmit` passes. `npm run faq-batch` (dry-run mode) lists discoverable batch files with correct slug grouping and target document IDs.</verify>
  <done>FAQ batch runner discovers 377 files, groups by slug, shows planned actions in dry-run. TypeScript compiles. npm script works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>FAQ batch runner tool with dry-run and execute modes</what-built>
  <how-to-verify>
    1. Run: `npm run faq-batch` (dry-run mode)
    2. Verify: Output lists FAQ batch files grouped by slug
    3. Verify: Each group shows target document ID (e.g., "crisis-management-bcm-en")
    4. Verify: Batch counts look correct (typically 3-5 batches per slug)
    5. Run: `npm run faq-batch -- --slug crisis-management-bcm` (dry-run for one slug)
    6. Verify: Only shows batches for that specific slug
    7. Optional: Run `npm run faq-batch -- --slug crisis-management-bcm --execute` to test actual FAQ upload for one page
    8. If executed: Check Sanity Studio to verify FAQs appeared on the crisis-management-bcm-en page
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/tools/faq-batch-runner.ts exists and compiles
- [ ] Dry-run mode lists all 377 batch files grouped by slug
- [ ] --slug filter works correctly
- [ ] --execute flag required for mutations (safe by default)
- [ ] npm run faq-batch script works
- [ ] Error handling doesn't crash on individual file failures
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- FAQ batch runner discovers and can process all 377 batch files
- Dry-run mode is safe (no mutations)
- Execute mode patches Sanity correctly
- Phase 3 complete — all core infrastructure in place
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-infrastructure/03-04-SUMMARY.md`
</output>
