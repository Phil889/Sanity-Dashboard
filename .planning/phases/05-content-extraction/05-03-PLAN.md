---
phase: 05-content-extraction
plan: 03
depends_on: ["05-01"]
files_modified:
  - src/lib/extraction-types.ts
  - src/tools/validate-extractions.ts
  - package.json
---

# Plan 05-03: Extraction Validation and Normalization

## Objective

Build validation and normalization for extracted content: TypeScript types defining the canonical extraction schema, validators that check extracted pages for completeness and correctness, and a CLI tool that validates a directory of extracted JSON files. This establishes the output contract between Phase 5 (extraction) and Phase 6 (translation engine).

## Execution Context

```yaml
strategy: A  # Fully autonomous, no checkpoints
estimated_tasks: 2
estimated_minutes: 20
parallel_safe: true  # Independent from 05-02
```

## Context

### Why Validation Matters

- 587 pages will be extracted, each with ~14 field groups and nested arrays
- Some fields are optional in practice (e.g., only 276/1419 pages have `heroImage.asset`)
- Missing `author` field in ~80% of testimonials (Deferred Issue #4)
- 1 document missing `language` field entirely (Deferred Issue #7)
- Phase 6 translation engine needs to know what to expect — validation defines the contract

### Schema from 01-04 Audit

**Required sections** (every German servicePage should have these):
- `_id` — string
- `_type` — `"servicePage"`
- `title` — string
- `language` — `"de"`
- `slug` — `{ _type: "slug", current: string }`
- `heroSection` — `{ heading, tagline, description, benefits[], heroImage? }`
- `overview` — `{ heading, description, additionalInfo?, alert?, points[], serviceDescription?, servicePoints[]?, whyUs? }`
- `approach` — `{ title, description, points[] }`
- `services` — array of `{ title, description, features[] }` (min 1)
- `faq` — array of `{ question, answer }` (min 1)
- `seo` — `{ title, description, keywords }`
- `testimonial` — `{ name?, position?, company?, quote }`

**Optional/conditional fields:**
- `heroSection.heroImage.asset` — only on ~20% of pages (just `alt` text on most)
- `overview.additionalInfo` — present on most but not guaranteed
- `overview.alert` — `{ title, content }` — not always present
- `overview.serviceDescription`, `overview.servicePoints` — sometimes missing
- `overview.whyUs` — `{ title, points[] }` — sometimes missing
- `testimonial.name`, `testimonial.position` — ~80% missing author details
- `parent` — reference, may be null for root-level pages
- `references.topLevelParent` — reference, may be null for root-level pages

### Dependencies

- **05-01** provides: `ExtractedPage` type exported from `src/tools/extract-page.ts`
- Schema knowledge from 01-04-SUMMARY.md (this plan)
- Does NOT depend on 05-02 (batch extraction) — can validate any extracted JSON

## Tasks

### Task 1: Create extraction types and validators

Create `src/lib/extraction-types.ts` with:

1. **Canonical type definitions** (re-export and extend from 05-01 if appropriate):
   - `HeroSection` — typed interface for heroSection content
   - `Overview` — typed interface for overview with optional fields marked
   - `Approach` — typed interface for approach section
   - `ServiceItem` — typed interface for each services[] entry
   - `FaqItem` — typed interface for each faq[] entry
   - `SeoMeta` — typed interface for seo section
   - `Testimonial` — typed interface for testimonial with optional author fields
   - `ExtractedPageSchema` — the full canonical schema that Phase 6 will consume

2. **Validation functions**:
   - `validateExtractedPage(data: unknown): ValidationResult`
     - Checks: _id is string, _type is "servicePage", language is "de"
     - Checks: slug.current is string and non-empty
     - Checks: heroSection has heading, tagline, description, benefits (array with items)
     - Checks: overview has heading and description at minimum
     - Checks: approach has title, description, points (array with items)
     - Checks: services is non-empty array, each item has title, description, features
     - Checks: faq is non-empty array, each item has question and answer
     - Checks: seo has title, description, keywords
     - Checks: testimonial exists (quote at minimum)
   - Returns `ValidationResult` with:
     - `valid: boolean` — all required checks pass
     - `errors: string[]` — list of required field failures
     - `warnings: string[]` — optional fields missing (not blocking but notable)
     - `stats: { faqCount, servicesCount, hasBenefits, hasHeroImage, hasTestimonialAuthor, hasWhyUs, hasAlert }`

3. **Field completeness helpers**:
   - `getFieldCompleteness(page: ExtractedPage): Record<string, boolean>` — maps every expected field path to present/missing
   - This is useful for Phase 6 to know which fields to translate

### Task 2: Create validation CLI tool

Create `src/tools/validate-extractions.ts` with:

1. **CLI interface**:
   - `--dir <path>` — directory containing extracted JSON files (default: `src/data/extracted`)
   - `--file <path>` — validate a single file instead of directory
   - `--json` — output full report as JSON
   - `--strict` — treat warnings as errors (for quality gate)

2. **Single-file validation mode** (`--file`):
   - Read JSON file, parse, run `validateExtractedPage()`
   - Display result: valid/invalid + errors + warnings + stats
   - Exit code 0 if valid, 1 if invalid

3. **Directory validation mode** (`--dir`):
   - Read all `*.json` files from directory (skip `.gitkeep`)
   - Validate each file
   - Aggregate results into summary report:
     ```
     Validation Summary
     ─────────────────────
     Total files:      587
     Valid:            582
     Invalid:            5

     Field Coverage
     ─────────────────────
     heroImage.asset:  117/587 (20%)
     testimonial.name: 120/587 (20%)
     overview.whyUs:   450/587 (77%)
     overview.alert:   530/587 (90%)

     FAQ Statistics
     ─────────────────────
     Min FAQs:         10
     Max FAQs:         40
     Avg FAQs:         20

     Invalid Files
     ─────────────────────
     file1.json: Missing heroSection.heading
     file2.json: Empty faq array
     ```
   - Exit code 0 if all valid (or all valid in non-strict), 1 if any invalid

4. **Add npm script**: `"validate-extractions": "tsx src/tools/validate-extractions.ts"`

### Verification with sample data

After both files are created, verify by:
1. Extract 3-5 pages using 05-01's extract tool (if available) or use existing source JSONs
2. Run single-file validation on each
3. Confirm valid pages pass, confirm field coverage stats are reasonable
4. If no extracted files exist yet, create a minimal test JSON manually and validate it

## Verification

- [ ] `ExtractedPageSchema` type covers all fields from 01-04 audit
- [ ] `validateExtractedPage()` correctly identifies valid pages
- [ ] `validateExtractedPage()` correctly reports missing required fields as errors
- [ ] `validateExtractedPage()` correctly reports missing optional fields as warnings
- [ ] `--file` mode validates a single JSON file
- [ ] `--dir` mode validates all files and produces aggregate report
- [ ] Field coverage statistics are accurate
- [ ] Exit codes: 0 for valid, 1 for invalid
- [ ] `npm run validate-extractions` works via npm script

## Success Criteria

A validation system that:
1. Defines the canonical extraction schema as TypeScript types
2. Validates extracted pages against the schema
3. Distinguishes required fields (errors) from optional fields (warnings)
4. Produces aggregate reports across all extracted files
5. Establishes the contract between Phase 5 output and Phase 6 input

## Output

- `src/lib/extraction-types.ts` — canonical types + validators (~150-200 lines)
- `src/tools/validate-extractions.ts` — validation CLI tool (~150-200 lines)
- Updated `package.json` with `"validate-extractions"` script
